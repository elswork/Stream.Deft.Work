<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Stream Deft Work - Login</title>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f0f2f5; }
        .container { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 350px; }
        h1, h2 { text-align: center; color: #333; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; color: #555; }
        input { width: 100%; padding: 0.5rem; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        button { width: 100%; padding: 0.7rem; border: none; border-radius: 4px; color: white; font-size: 1rem; cursor: pointer; margin-top: 0.5rem; }
        .btn-primary { background-color: #007bff; }
        .btn-secondary { background-color: #6c757d; }
        .btn-google { background-color: #db4437; }
        #userInfo { text-align: center; margin-top: 1rem; }
        #auth-forms { display: block; }
        #app-content { display: none; }
        .error { color: red; text-align: center; margin-top: 1rem; }
        #websocket-controls { margin-top: 1.5rem; border-top: 1px solid #eee; padding-top: 1.5rem; }
        #buttons-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 1rem; }
        .grid-button { padding: 1rem; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="container">
        <div id="auth-forms">
            <h1>Stream Deft Work</h1>
            <div id="login-form">
                <h2>Iniciar Sesión</h2>
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Contraseña</label>
                    <input type="password" id="login-password" required>
                </div>
                <button id="login-button" class="btn-primary">Login</button>
                <button id="google-login-button" class="btn-google">Login con Google</button>
                <p style="text-align:center; margin-top:1rem;">¿No tienes cuenta? <a href="#" id="show-register">Regístrate</a></p>
            </div>

            <div id="register-form" style="display:none;">
                <h2>Registro</h2>
                <div class="form-group">
                    <label for="register-email">Email</label>
                    <input type="email" id="register-email" required>
                </div>
                <div class="form-group">
                    <label for="register-password">Contraseña</label>
                    <input type="password" id="register-password" required>
                </div>
                <button id="register-button" class="btn-primary">Registrar</button>
                <p style="text-align:center; margin-top:1rem;">¿Ya tienes cuenta? <a href="#" id="show-login">Inicia sesión</a></p>
            </div>
             <p id="auth-error" class="error"></p>
        </div>

        <div id="app-content">
            <h1>¡Bienvenido!</h1>
            <div id="userInfo"></div>

            <div id="websocket-controls">
                <h2>Conexión al PC</h2>
                <div class="form-group">
                    <label for="server-ip">IP del Servidor</label>
                    <input type="text" id="server-ip" placeholder="Ej: 192.168.1.100">
                </div>
                <button id="connect-button" class="btn-primary">Conectar</button>
                <p id="ws-status" style="text-align: center; margin-top: 1rem;"></p>
            </div>

            <div id="buttons-grid" style="display:none;">
                 <button class="grid-button btn-secondary" data-action='{"action": "type", "payload": "Hola desde la web!"}'>Escribir 'Hola'</button>
                 <button class="grid-button btn-secondary" data-action='{"action": "key_tap", "payload": "enter"}'>Pulsar Enter</button>
                 <button class="grid-button btn-secondary" data-action='{"action": "mouse_click"}'>Click Izquierdo</button>
            </div>

            <button id="logout-button" class="btn-secondary" style="margin-top: 2rem;">Cerrar Sesión</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBRa3cOK8yxao-OJNHeH9U8bmuti60C2-g",
            authDomain: "stream-deft-work.firebaseapp.com",
            projectId: "stream-deft-work",
            storageBucket: "stream-deft-work.appspot.com",
            messagingSenderId: "702351000662",
            appId: "1:702351000662:web:5d26bfba3192ba6def27f7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        // WebSocket variable
        let ws;

        // DOM Elements
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const appContent = document.getElementById('app-content');
        const authForms = document.getElementById('auth-forms');
        const userInfo = document.getElementById('userInfo');
        const authError = document.getElementById('auth-error');
        const serverIpInput = document.getElementById('server-ip');
        const connectButton = document.getElementById('connect-button');
        const wsStatus = document.getElementById('ws-status');
        const buttonsGrid = document.getElementById('buttons-grid');

        // Buttons
        const loginButton = document.getElementById('login-button');
        const registerButton = document.getElementById('register-button');
        const googleLoginButton = document.getElementById('google-login-button');
        const logoutButton = document.getElementById('logout-button');
        
        // Links
        const showRegisterLink = document.getElementById('show-register');
        const showLoginLink = document.getElementById('show-login');

        // --- WebSocket Functions ---
        function connectWebSocket() {
            const ip = serverIpInput.value;
            if (!ip) {
                wsStatus.innerText = "Por favor, introduce una IP.";
                wsStatus.style.color = "red";
                return;
            }

            wsStatus.innerText = `Conectando a wss://${ip}:8080...`;
            wsStatus.style.color = "orange";
            
            ws = new WebSocket(`wss://${ip}:8080`);

            ws.onopen = () => {
                console.log("Conexión WebSocket establecida.");
                wsStatus.innerText = "Conectado";
                wsStatus.style.color = "green";
                buttonsGrid.style.display = "grid";
            };

            ws.onmessage = (event) => {
                console.log("Mensaje recibido del servidor:", event.data);
                // Aquí se podría manejar feedback del servidor
            };

            ws.onclose = () => {
                console.log("Conexión WebSocket cerrada.");
                wsStatus.innerText = "Desconectado";
                wsStatus.style.color = "red";
                buttonsGrid.style.display = "none";
            };

            ws.onerror = (error) => {
                console.error("Error en WebSocket:", error);
                wsStatus.innerText = "Error de conexión";
                wsStatus.style.color = "red";
                buttonsGrid.style.display = "none";
            };
        }

        function sendWsMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(message);
            } else {
                console.error("WebSocket no está conectado.");
                wsStatus.innerText = "Error: No conectado";
                wsStatus.style.color = "red";
            }
        }


        // --- Event Listeners ---

        // Auth State Change
        auth.onAuthStateChanged(user => {
            if (user) {
                if (user.emailVerified) {
                    console.log("Usuario verificado y logueado:", user);
                    authForms.style.display = 'none';
                    appContent.style.display = 'block';
                    userInfo.innerText = `Logueado como: ${user.email}`;
                } else {
                    authForms.style.display = 'block';
                    appContent.style.display = 'none';
                    loginForm.style.display = 'block';
                    registerForm.style.display = 'none';
                    authError.innerText = 'Por favor, verifica tu email para continuar. Revisa tu bandeja de entrada.';
                    auth.signOut(); // Forzamos logout si no está verificado
                }
            } else {
                console.log("No hay usuario logueado.");
                authForms.style.display = 'block';
                appContent.style.display = 'none';
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                userInfo.innerText = '';
                authError.innerText = '';
                if (ws) ws.close(); // Cierra el websocket si el usuario se desloguea
            }
        });

        // Register Button
        registerButton.addEventListener('click', e => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            authError.innerText = '';

            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    userCredential.user.sendEmailVerification()
                        .then(() => {
                            alert('¡Registro exitoso! Se ha enviado un correo de verificación. Por favor, revisa tu bandeja de entrada y haz clic en el enlace para poder iniciar sesión.');
                        });
                })
                .catch(error => {
                    console.error("Error en el registro:", error);
                    authError.innerText = error.message;
                });
        });

        // Login Button
        loginButton.addEventListener('click', e => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            authError.innerText = '';

            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    console.error("Error en el login:", error);
                    authError.innerText = error.message;
                });
        });

        // Google Login Button
        googleLoginButton.addEventListener('click', () => {
            authError.innerText = '';
            auth.signInWithPopup(googleProvider)
                .catch(error => {
                    console.error("Error con Google:", error);
                    authError.innerText = error.message;
                });
        });

        // Logout Button
        logoutButton.addEventListener('click', () => {
            auth.signOut();
        });
        
        // Toggle forms
        showRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
            authError.innerText = '';
        });

        showLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.style.display = 'none';
            loginForm.style.display = 'block';
            authError.innerText = '';
        });

        // WebSocket Connect Button
        connectButton.addEventListener('click', connectWebSocket);

        // Action Buttons
        buttonsGrid.addEventListener('click', (e) => {
            if (e.target.classList.contains('grid-button')) {
                const actionData = e.target.dataset.action;
                sendWsMessage(actionData);
            }
        });

    </script>

</body>
</html>
